<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>StreamLinkSync</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
<header class="bg-sky-700 text-white p-4 shadow">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">StreamLinkSync</h1>
      <p class="text-sm opacity-90">Atualiza√ß√µes a cada 6h ‚Äî For√ßar atualiza√ß√£o com segredo</p>
    </div>
    <div class="flex gap-2 items-center">
      <button id="forceBtn" class="bg-rose-500 hover:bg-rose-600 text-white px-3 py-2 rounded">For√ßar atualiza√ß√£o</button>
      <button id="refreshBtn" class="bg-white text-sky-700 border border-sky-700 px-3 py-2 rounded">Recarregar lista</button>
    </div>
  </div>
</header>
<main class="max-w-6xl mx-auto p-4">
  <div class="flex gap-3 mb-4">
    <input id="q" class="flex-1 p-2 border rounded" placeholder="Buscar..." />
    <select id="sort" class="p-2 border rounded">
      <option value="name_asc">Nome ‚Üë</option>
      <option value="name_desc">Nome ‚Üì</option>
      <option value="updated_desc">√öltima atualiza√ß√£o ‚Üì</option>
      <option value="updated_asc">√öltima atualiza√ß√£o ‚Üë</option>
    </select>
  </div>
  <div id="status" class="text-sm text-slate-600 mb-3">Pronto.</div>
  <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</main>
<script>
const API_ROOT = '';

function setStatus(t){ document.getElementById('status').textContent = t; }
async function api(path, opts){ const r = await fetch(API_ROOT + path, opts); if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }

function sortItems(items, mode){
  return items.sort((a,b)=>{
    if(mode==='name_asc') return (a.name||'').localeCompare(b.name||'');
    if(mode==='name_desc') return (b.name||'').localeCompare(a.name||'');
    if(mode==='updated_desc') return ((b.last_updated||'').localeCompare(a.last_updated||''));
    if(mode==='updated_asc') return ((a.last_updated||'').localeCompare(b.last_updated||''));
    return 0;
  });
}

async function load(){
  setStatus('Carregando...');
  try{
    const data = await api('/api/live/list');
    window._items = data;
    render();
    setStatus(data.length + ' canais');
  }catch(e){ setStatus('Erro ao carregar: ' + e.message); }
}

function render(){
  const q = document.getElementById('q').value.toLowerCase();
  const mode = document.getElementById('sort').value;
  let items = (window._items || []).filter(i => (i.name||'').toLowerCase().includes(q));
  items = sortItems(items, mode);
  const grid = document.getElementById('grid'); grid.innerHTML='';
  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'bg-white rounded shadow p-4 flex flex-col gap-2';
    el.innerHTML = `
      <div class="font-semibold">${it.name||'Sem nome'}</div>
      <div class="text-xs text-slate-500 truncate">${it.m3u8_url||''}</div>
      <div class="text-xs text-slate-500">Atualizado: ${it.last_updated||''}</div>
      <div class="flex gap-2 mt-2">
        <a class="px-3 py-1 bg-sky-600 text-white rounded" href="${it.m3u8_url||'#'}" target="_blank">‚ñ∂ Abrir</a>
        <button class="px-3 py-1 border rounded" onclick="copyToClipboard('${it.m3u8_url||''}')">üìã Copiar</button>
      </div>`;
    grid.appendChild(el);
  });
}

function copyToClipboard(t){ navigator.clipboard.writeText(t); alert('Copiado'); }

document.getElementById('q').addEventListener('input', load);
document.getElementById('sort').addEventListener('change', render);
document.getElementById('refreshBtn').addEventListener('click', load);

document.getElementById('forceBtn').addEventListener('click', async ()=>{
  const secret = prompt('Insira o CRON_SECRET para for√ßar a atualiza√ß√£o (n√£o ser√° armazenado):');
  if(!secret) return alert('Cancelado');
  setStatus('Enviando requisi√ß√£o de atualiza√ß√£o...');
  try{
    const res = await fetch('/api/update', { method:'GET', headers: { 'x-cron-key': secret } });
    const body = await res.json();
    if(!res.ok) throw new Error(body && body.error ? body.error : 'HTTP ' + res.status);
    setStatus('Atualiza√ß√£o disparada: ' + JSON.stringify(body));
    setTimeout(load, 3000);
  }catch(e){ setStatus('Erro: ' + e.message); }
});

load();
</script>
</body>
</html>
