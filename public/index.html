
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StreamLinkSync</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="bg-sky-700 text-white p-4 shadow">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-2xl font-semibold">StreamLinkSync</h1>
      <p class="text-sm opacity-90">Gerencia links M3U8 (YouTube + probe). Atualiza√ß√£o autom√°tica 6h (gate).</p>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4">
    <div class="flex gap-3 mb-4">
      <input id="q" class="flex-1 p-2 border rounded" placeholder="Buscar canal..." />
      <select id="sort" class="p-2 border rounded">
        <option value="name">Ordenar: Nome</option>
        <option value="recent">Ordenar: Mais recentes</option>
      </select>
      <button id="force" class="px-4 py-2 bg-green-600 text-white rounded">For√ßar atualiza√ß√£o</button>
    </div>

    <div id="status" class="text-sm text-slate-600 mb-3">Pronto.</div>
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>

  <script>
    const API_ROOT = '';

    async function apiFetch(path, opts) {
      const res = await fetch(API_ROOT + path, opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    async function loadList() {
      const st = document.getElementById('status');
      st.textContent = 'Carregando...';
      try {
        const data = await apiFetch('/api/live/list');
        renderList(data);
        st.textContent = `${data.length} canais`;
      } catch (err) {
        st.textContent = 'Erro: ' + err.message;
      }
    }

    function renderList(items) {
      const q = document.getElementById('q').value.toLowerCase();
      const sort = document.getElementById('sort').value;
      let filtered = items.filter(i => (i.name || '').toLowerCase().includes(q));
      if (sort === 'recent') filtered.sort((a,b) => (b.last_updated||'').localeCompare(a.last_updated||''));
      else filtered.sort((a,b) => (a.name||'').localeCompare(b.name||''));
      const grid = document.getElementById('grid'); grid.innerHTML = '';
      filtered.forEach(i => {
        const el = document.createElement('div');
        el.className = 'bg-white rounded shadow p-4 flex flex-col gap-2';
        el.innerHTML = `
          <div class="font-semibold">${i.name || 'Sem nome'}</div>
          <div class="text-xs text-slate-500 truncate">${i.m3u8_url || ''}</div>
          <div class="text-xs text-slate-500">Atualizado: ${i.last_updated || ''}</div>
          <div class="flex gap-2">
            <a class="px-3 py-1 bg-sky-600 text-white rounded" target="_blank" href="${i.m3u8_url||'#'}">‚ñ∂ Abrir</a>
            <button class="px-3 py-1 border rounded" onclick="navigator.clipboard.writeText('${i.m3u8_url||''}')">üìã Copiar</button>
          </div>`;
        grid.appendChild(el);
      });
    }

    document.getElementById('q').addEventListener('input', loadList);
    document.getElementById('sort').addEventListener('change', loadList);
    document.getElementById('force').addEventListener('click', async () => {
      const st = document.getElementById('status');
      if (!confirm('For√ßar atualiza√ß√£o agora? Isso acionar√° a rotina de extra√ß√£o.')) return;
      st.textContent = 'Solicitando atualiza√ß√£o...';
      try {
        const res = await fetch('/api/update', { method: 'POST' });
        const j = await res.json();
        if (!res.ok) throw new Error(j.error || 'Erro');
        st.textContent = 'Atualiza√ß√£o executada: ' + JSON.stringify(j);
        setTimeout(loadList, 2000);
      } catch (e) {
        st.textContent = 'Erro: ' + e.message;
      }
    });

    loadList();
  </script>
</body>
</html>
